---
title: "Insights - Tabela de Dados da Aeronaútica"
author: "Gabriel Marreiros"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
---

```{r rmarkdown_setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)

# Pacotes
library(data.table) # Framework de manipulação dos dados
library(magrittr) # Apenas para usar algumas funções no console mais rápidas
```

# Introdução

A ideia desse documento é pegar um dataset com qual não tenho familiaridade e tentar extrair algum tipo de *insight* ou algum fato interessante usando R, usando especialmente data.table, Rmarkdown para compilar um documento de como fui me mergulhando nos dados junto com alguns htmlwidgets no caminho, e possivelmente criar um demo de um aplicativo shiny no final.

Nesse caso, escolhi um dataset que me interessou sobre **Ocorrências Aeronáuticas na Aviação Civil Brasileira**. Imagino que terá como mexer um pouco com mapas usando Leatlet ou alguma outra direção que quisermos tomar. 

Esses datasets são extraídos da CENIPA e estão disponíveis no [site de dados abertos do Governo Federal](https://dados.gov.br/dataset/ocorrencias-aeronauticas-da-aviacao-civil-brasileira).

Segue uma breve descrição do que está no site: 
> A base de dados de ocorrências aeronáuticas é gerenciada pelo Centro de Investigação e Prevenção de Acidentes Aeronáuticos (CENIPA). Constam nesta base de dados as ocorrências aeronáuticas notificadas ao CENIPA nos últimos 10 anos e que ocorreram em solo brasileiro.

> Dentre as informações disponíveis estão os dados sobre as aeronaves envolvidas, fatalidades, local, data, horário dos eventos e informações taxonômicas típicas das investigações de acidentes (AIG). São resguardadas a privacidade de pessoas físicas/jurídicas envolvidas conforme previsto pela Lei de Acesso à Informação (Lei n° 12.527, de 18 de novembro de 2011). 

# Programa

## Importação dos Dados

Bom, iniciamos o programa importando as informações do portal da CENIPA (Centro de Investigação e Prevenção de Acidentes Aeronáuticos) encontrados no link mencionados na Introdução.

Note que se importarmos o programa sem especificar o encoding como "UTF-8", então caracteres especiais do Português Brasil serão lidos incorretamente. e.g. "ã", "é", "Ç", etc.

<!-- Importa tabelas do portal de dados abertos do Governo Federal -->
<!-- https://dados.gov.br/dataset/ocorrencias-aeronauticas-da-aviacao-civil-brasileira -->
```{r Importando dados da CENIPA}
# Tabela principal - Ocorrência
ocorrencia <- data.table::fread(
  "http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/ocorrencia.csv",
  encoding = "UTF-8"
)

# Tabela Complementar 1 - Código de Ocorrência 1
ocorrencia_tipo <- data.table::fread(
  "http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/ocorrencia_tipo.csv",
  encoding = "UTF-8"
)

# Tabela Complementar 2 - Código de Ocorrência 2
aeronave <- data.table::fread(
  "http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/aeronave.csv",
  encoding = "UTF-8"
)

# Tabela Complementar 3 - Código de Ocorrência 3
fator_contribuinte <- data.table::fread(
  "http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/fator_contribuinte.csv",
  encoding = "UTF-8"
)

# Tabela Complementar 4 - Código de Ocorrência 4
recomendacao <- data.table::fread(
  "http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/recomendacao.csv",
  encoding = "UTF-8"
)
```


## Cruzamento dos Dados

### Explicação

Normalmente, essa seria um bom momento de dar uma olhada em algumas colunas e vermos o que podemos fazer com elas. No entanto, lendo as informações no site de dados do Governo Federal, notamos que apesar de termos 5 tabelas diferentes, há uma tabela central que possui informações adicionais distribuídas nas outras 4, assim como na imagem a seguir:

![Relacionamento de dados das tabelas que usaremos](http://sistema.cenipa.aer.mil.br/cenipa/media/opendata/modelo_dados.png "Deve ser simples, certo?")
Como as tabelas são bem pequenas com menos 10 mil linhas e 30 colunas, cruzá-las e trazer todas as informações em um único dataset poderá facilitar o tratamento de dados mais para frente. Talvez fique um pouco mais difícil de ter uma panorama geral só batendo o olho, mas dado o número colunas parece ser algo tolerável.

Como estou usando o pacote data.table, vamos utilizá-lo para cruzar as informações baseado na chave seguindo a imagem do relacionamento de dados das tabelas acima. Extraindo as informações, seria algum assim:

```{r Criando tabela de exemplo 1, echo=FALSE}
nome_tabelas_complementares = list("OCORRENCIA_TIPO", "AERONAVE", "FATOR_CONTRIBUINTE", "RECOMENDACAO")
chave_tabelas_complementares = list("codigo_ocorrencia1", "codigo_ocorrencia2", "codigo_ocorrencia3", "codigo_ocorrencia4")

reactable::reactable(data.table::data.table(nome_tabelas_complementares, chave_tabelas_complementares))
```

### Cruzamento

Primeira coisa, vamos dar um head para ter um panorama geral da tabela principal, *ocorrencia* - especialmente das chaves. Nunca se sabe se algo deu errado.

```{r Head da chave da base Ocorrencia antes do cruzamento}
head(ocorrencia[, c("codigo_ocorrencia", "codigo_ocorrencia1", "codigo_ocorrencia2", "codigo_ocorrencia3", "codigo_ocorrencia4")])
```

Opa! Olhando o header, parece que ocorreu algo de muito estranho. As 5 primeiras linhas das 5 chaves possuem o valor idêntico!

Note que isso não significa que todas as linhas serão iguais. Porém, há uma leve suspeita para sabermos se isso é muito mais que uma mera coincidência.

Para checarmos no R se as colunas possuem valores, iguais podemos usar a função *identical* para saber se os elementos são iguais.

```{r Checagem 1 - Colunas das chaves são idênticas}
identical(
  ocorrencia[, codigo_ocorrencia], 
  ocorrencia[, codigo_ocorrencia1], 
  ocorrencia[, codigo_ocorrencia2],
  ocorrencia[, codigo_ocorrencia3],
  ocorrencia[, codigo_ocorrencia4]
)
```

E olha só! As colunas são de fato idênticas! Pode ser que um dia essas colunas sejam diferentes por algum motivo, mas no momento de nossa análise elas são idênticas.

Isso não mudará muita coisa no nosso cruzamento, mas isso significa que podemos descartar alguns dados mais para frente, pós o cruzamento.

Voltando ao que interessa, vamos para o cruzamento - fazendo 4 left joins seguidos:

> cruzamento1 <- ocorrencia[ocorrencia_tipo, on = "codigo_ocorrencia1"]
cruzamento2 <- cruzamento1[aeronave, on = "codigo_ocorrencia2"]
cruzamento3 <- cruzamento2[fator_contribuinte, on = "codigo_ocorrencia3"]
tabela <- cruzamento3[recomendacao, on = "codigo_ocorrencia4"]

Rodando o código acima, obteremos um erro vindo do último cruzamento, um left join entre *ocorrencia* e *recomendacao*:

> Error in vecseq(f__, len__, if (allow.cartesian || notjoin || !anyDuplicated(f__, : 
Join results in 11387 rows; more than 6687 = nrow(x)+nrow(i). Check for duplicate key values in i each of which join to the same group in x over and over again. If that's ok, try by=.EACHI to run j for each group to avoid the large allocation. If you are sure you wish to proceed, rerun with allow.cartesian=TRUE. Otherwise, please search for this error message in the FAQ, Wiki, Stack Overflow and data.table issue tracker for advice.

Aparentemente as chaves de alguma das duas tabelas não são únicas. Como a tabela principal, *ocorrencia*, cruzou com as outras 3 tabelas, vamos dar uma olhadinha na tabela *recomendacao*:

```{r}
str(recomendacao)
```
Opa! Podemos ver que *codigo_ocorrencia4* de fato ocorre duas vezes! Mas por quê? Vamos dar uma analisada mais afundo na base e ver se podemos entendê-la melhor. Também darei uma olhada se há um metadados dessa tabela lá no site - possibilitando o nosso melhor entendimento do que de fato seja uma recomendação.

```{r Cruzando as tabelas, include=FALSE}
cruzamento1 <- ocorrencia[ocorrencia_tipo, on = "codigo_ocorrencia1"]
cruzamento2 <- cruzamento1[aeronave, on = "codigo_ocorrencia2"]
cruzamento3 <- cruzamento2[fator_contribuinte, on = "codigo_ocorrencia3"]
#tabela <- cruzamento3[recomendacao, on = "codigo_ocorrencia4"]
```
